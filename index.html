<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½ä¿å¯†å”è­° - è‹‘ç¨‹æœ‰é™å…¬å¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #0f172a; min-height: 100vh; overflow-x: hidden; }
        .header-banner { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); position: fixed; top: 0; left: 0; right: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .header-logo { height: 40px; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); color: white; width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; }
        .glass-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .paper-ui { background-color: #ffffff; color: #111827; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #3b82f6; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #signatureCanvas { touch-action: none; cursor: crosshair; border: 2px dashed #ccc; background: #fafafa; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .contract-content { white-space: pre-wrap; line-height: 1.8; text-align: justify; }
    </style>
</head>
<body class="flex items-center justify-center p-4 pt-24">

    <div class="header-banner">
        <img src="logo.png" alt="Logo" class="header-logo">
        <span class="text-white font-medium text-sm md:text-base">ç¿»è­¯æ³¡èŠ™å­¸é™¢ | è‹‘ç¨‹æœ‰é™å…¬å¸</span>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <span class="loader mb-4"></span>
        <p id="loadingText" class="text-white text-lg tracking-widest">åˆå§‹åŒ–ç³»çµ±ä¸­...</p>
    </div>

    <div class="w-full max-w-3xl">
        <!-- Step 1: å¡«å¯«è³‡æ–™ -->
        <div id="step1" class="glass-card rounded-2xl p-6 md:p-10 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-white mb-2">ä¿ å¯† å” è­° ç°½ ç½²</h1>
                <p class="text-blue-200 text-sm">è«‹è¼¸å…¥æ‚¨çš„åŸºæœ¬è³‡æ–™</p>
            </div>
            <form id="infoForm" class="space-y-5">
                <div>
                    <label class="block text-blue-200 text-sm mb-1">ä¸Šèª²æ—¥æœŸ (ä¾‹å¦‚: 0117)</label>
                    <input type="text" id="inputDate" maxlength="4" required class="glass-input" placeholder="è«‹è¼¸å…¥å››ä½æ—¥æœŸæ•¸å­—">
                </div>
                <div>
                    <label class="block text-blue-200 text-sm mb-1">å§“å (Name)</label>
                    <input type="text" id="inputName" required class="glass-input" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                </div>
                <div>
                    <label class="block text-blue-200 text-sm mb-1">èº«åˆ†è­‰å­—è™Ÿ (ID Number)</label>
                    <input type="text" id="inputID" required class="glass-input uppercase" placeholder="A123456789">
                </div>
                <div>
                    <label class="block text-blue-200 text-sm mb-1">é›»å­ä¿¡ç®± (Email)</label>
                    <p class="text-blue-400 text-xs mb-2">ğŸ’¡ ç°½ç½²å®Œæˆå¾Œå‰¯æœ¬å°‡å¯„é€è‡³æ­¤ï¼Œè«‹å‹™å¿…å¡«å¯«æ­£ç¢ºã€‚</p>
                    <input type="email" id="inputEmail" required class="glass-input" placeholder="example@email.com">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg transition-all mt-4">
                    ä¸‹ä¸€æ­¥ï¼šé–±è®€å”è­°å…§å®¹
                </button>
            </form>
        </div>

        <!-- Step 2: å”è­°å…§å®¹ -->
        <div id="step2" class="paper-ui rounded-lg p-6 md:p-12">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 border-b-2 border-black inline-block pb-1">ä¿ å¯† å” è­° æ›¸</h2>
            </div>
            
            <div id="contractDisplay" class="contract-content text-gray-800 text-sm md:text-base mb-8">
                <!-- é€™è£¡æœƒç”±å¾Œç«¯è‡ªå‹•å¡«å……æ–‡å­— -->
                è¼‰å…¥å”è­°å…§å®¹ä¸­...
            </div>

            <div class="border-t pt-8 space-y-4">
                <p><strong>ç«‹æ›¸äººå§“åï¼š</strong> <span id="displayName" class="underline"></span></p>
                <div>
                    <label class="block text-sm font-bold text-gray-900 mb-2">è«‹åœ¨æ­¤ç°½åï¼š <span class="text-red-500">*</span></label>
                    <canvas id="signatureCanvas" class="w-full h-64 rounded-lg"></canvas>
                    <button type="button" id="clearBtn" class="mt-2 text-sm text-gray-500 underline">æ¸…é™¤é‡æ–°ç°½å</button>
                </div>
                <button id="finalSubmitBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-lg shadow-xl text-lg mt-6">
                    æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾ï¼Œç¢ºèªé€å‡º
                </button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBEMq10DZ9M2JQVM1VkTSv463c4X_HfyL8tNT52_3UjIEagemn6DuF2wU0ZIEmVwUK8g/exec"; // ğŸ‘ˆ è«‹å¡«å…¥ä½ æœ€æ–°éƒ¨ç½²çš„ç¶²å€
        
        let whitelist = {}; // é€šé—œæ—¥æœŸåå–®
        let fullContractText = ""; // åˆç´„æ–‡å­—å…§å®¹
        let isDataLoaded = false;

        // ä¸€å•Ÿå‹•å°±å»æŠ“å¾Œç«¯è³‡æ–™
        window.onload = async function() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                if (result.status === 'success') {
                    whitelist = result.whitelist;
                    fullContractText = result.contractText;
                    isDataLoaded = true;
                    document.getElementById('loadingOverlay').style.display = 'none';
                } else {
                    throw new Error("åˆå§‹åŒ–å¤±æ•—");
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'ç³»çµ±é€£ç·šå¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«å®¢æœ' });
            }
        };

        const canvas = document.getElementById('signatureCanvas');
        const signaturePad = new SignaturePad(canvas);

        // è‡ªå‹•èª¿æ•´ç•«å¸ƒå¤§å°
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.onresize = resizeCanvas;

        // è¡¨å–®æäº¤æª¢æŸ¥æ—¥æœŸ
        document.getElementById('infoForm').onsubmit = function(e) {
            e.preventDefault();
            const dateInput = document.getElementById('inputDate').value.trim();
            
            // æ™ºæ…§æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ç™½åå–®å…§
            if (!whitelist[dateInput]) {
                Swal.fire({ icon: 'error', title: 'æ—¥æœŸä¸æ­£ç¢º', text: 'æ—¥æœŸä¸æ­£ç¢ºï¼Œè«‹è·Ÿå®¢æœç¢ºèªæ™‚é–“', confirmButtonColor: '#1e3a8a' });
                return;
            }

            // é¡¯ç¤ºç¬¬äºŒé 
            document.getElementById('displayName').innerText = document.getElementById('inputName').value;
            document.getElementById('contractDisplay').innerText = fullContractText;
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            resizeCanvas();
            window.scrollTo(0,0);
        };

        document.getElementById('clearBtn').onclick = () => signaturePad.clear();

        // æœ€çµ‚é€å‡º
        document.getElementById('finalSubmitBtn').onclick = async function() {
            if (signaturePad.isEmpty()) {
                Swal.fire({ icon: 'warning', title: 'è«‹å…ˆå®Œæˆç°½å' });
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').innerText = "æ­£åœ¨å®‰å…¨å‚³è¼¸ä¸­...";

            const payload = {
                courseDate: document.getElementById('inputDate').value,
                name: document.getElementById('inputName').value,
                id: document.getElementById('inputID').value,
                email: document.getElementById('inputEmail').value,
                signature_base64: signaturePad.toDataURL()
            };

            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                document.getElementById('loadingOverlay').style.display = 'none';
                
                if (result.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'ç°½ç½²å®Œæˆ', text: 'å‰¯æœ¬å·²å¯„é€è‡³æ‚¨çš„ä¿¡ç®±', allowOutsideClick: false })
                    .then(() => location.reload());
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire({ icon: 'error', title: 'é€å‡ºå¤±æ•—', text: e.toString() });
            }
        };
    </script>
</body>
</html>
