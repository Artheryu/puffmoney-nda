<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½ä¿å¯†å”è­° - è‹‘ç¨‹æœ‰é™å…¬å¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #020617; min-height: 100vh; margin: 0; padding-bottom: 50px; overscroll-behavior-y: none; }
        .header-banner { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); position: fixed; top: 0; left: 0; right: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .header-logo { height: 32px; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); color: white; width: 100%; padding: 0.8rem 1rem; border-radius: 0.5rem; }
        .paper-ui { background: #ffffff; color: #111827; display: none; border-radius: 4px; padding: 60px 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9); position: relative; margin-top: 20px; border: 1px solid #e2e8f0; }
        .paper-ui::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 10px; background: #1e3a8a; border-radius: 4px 4px 0 0; }
        .contract-content { white-space: pre-wrap; line-height: 2.2; text-align: justify; font-size: 15px; color: #1f2937; margin-bottom: 30px; }
        .highlight-bold { font-weight: 900 !important; color: #000 !important; background: #ffff00; padding: 2px 4px; border-radius: 2px; text-decoration: underline; font-size: 1.05em; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .loader { width: 50px; height: 50px; border: 5px solid #FFF; border-bottom-color: #3b82f6; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ğŸ’¡ ä¿®æ­£ï¼šå¢åŠ  !important ç¢ºä¿é–å®šè§¸æ§ */
        #signatureCanvas { 
            touch-action: none !important; 
            cursor: crosshair; 
            border: 2px solid #cbd5e1; 
            background: #fff; 
            width: 100%; 
            height: 220px; 
            border-radius: 4px; 
        }
        .inline-address-input { border: 2px solid #1e3a8a; background: #f0f9ff; padding: 12px 15px; width: 100%; font-weight: 900; font-size: 16px; outline: none; border-radius: 8px; color: #1e3a8a; }
    </style>
</head>
<body class="flex items-center justify-center p-4 pt-24">

    <div class="header-banner"><img src="logo.png" alt="Logo" class="header-logo"><span class="text-white font-bold text-xs md:text-sm tracking-widest">ç¿»è­¯æ³¡èŠ™å­¸é™¢ | è‹‘ç¨‹æœ‰é™å…¬å¸</span></div>
    <div id="loadingOverlay" class="loading-overlay"><span class="loader mb-4"></span><p id="loadingText" class="text-white text-sm tracking-widest">ç³»çµ±è™•ç†ä¸­...</p></div>

    <div class="w-full max-w-2xl">
        <div id="step1" class="glass-card rounded-3xl p-8 md:p-12 fade-in">
            <div class="text-center mb-10"><h1 class="text-3xl font-black text-white mb-2 tracking-tighter">ä¿å¯†å”è­°ç°½ç½²</h1><div class="h-1 w-20 bg-blue-500 mx-auto"></div></div>
            <form id="infoForm" class="space-y-6">
                <div><label class="block text-blue-200 text-xs font-bold mb-1">ä¸Šèª²æ—¥æœŸ (ä¾‹å¦‚: 0117)</label><input type="text" id="inputDate" maxlength="4" required class="glass-input" oninput="this.value=this.value.replace(/[^0-9]/g,'')" placeholder="0000"></div>
                <div><label class="block text-blue-200 text-xs font-bold mb-1">çœŸå¯¦å§“å (Full Name)</label><input type="text" id="inputName" required class="glass-input" placeholder="å§“å"></div>
                <div>
                    <div class="flex justify-between items-center mb-1"><label class="text-blue-200 text-xs font-bold">èº«åˆ†è­‰ / è­‰ä»¶è™Ÿç¢¼</label><label class="text-blue-400 text-[11px] flex items-center cursor-pointer"><input type="checkbox" id="isOverseas" class="mr-1">æµ·å¤–äººå£«(è­·ç…§)</label></div>
                    <input type="text" id="inputID" maxlength="10" required class="glass-input uppercase" placeholder="A123456789">
                </div>
                <div><label class="block text-blue-200 text-xs font-bold mb-1">è¯çµ¡é›»è©± (æœ€å¤š 10 ç¢¼)</label><input type="tel" id="inputPhone" maxlength="10" required class="glass-input" oninput="this.value=this.value.replace(/[^0-9]/g,'')" placeholder="09xxxxxxxx"></div>
                <div><label class="block text-blue-200 text-xs font-bold mb-1">é›»å­ä¿¡ç®± (Email)</label><input type="email" id="inputEmail" required class="glass-input" placeholder="example@email.com"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-xl transform transition active:scale-95 text-lg mt-4">ä¸‹ä¸€æ­¥ï¼šé è¦½åˆç´„</button>
            </form>
        </div>

        <div id="step2" class="paper-ui fade-in">
            <div class="text-center mb-12"><h2 class="text-3xl font-black text-gray-900 border-b-4 border-gray-900 inline-block pb-1 tracking-widest">ä¿ å¯† å” è­° æ›¸</h2></div>
            <div id="contractDisplay" class="contract-content"></div>
            <div class="bg-blue-50 p-6 rounded-lg border-l-8 border-blue-600 mb-10 shadow-inner">
                <label class="block text-blue-900 font-black text-sm mb-2">è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„é€šè¨Šåœ°å€ (å¿…å¡«)ï¼š</label>
                <input type="text" id="inputAddress" class="inline-address-input" placeholder="è¼¸å…¥æ‚¨çš„å®Œæ•´è¯çµ¡åœ°å€">
            </div>
            <div class="border-t-2 border-gray-900 pt-8 space-y-6">
                <p class="font-bold text-lg">ç«‹æ›¸äºº(ä¹™æ–¹)ï¼š<span id="displayName" class="highlight-bold"></span></p>
                <div><label class="block text-sm font-black text-gray-900 mb-2 underline">è«‹åœ¨æ­¤ç°½å (Signature)ï¼š *</label><canvas id="signatureCanvas"></canvas><button type="button" id="clearBtn" class="mt-2 text-xs text-gray-400 font-bold hover:text-red-500 transition">CLEAR / æ¸…é™¤é‡ç°½</button></div>
                <button id="finalSubmitBtn" class="w-full bg-black hover:bg-gray-800 text-white font-black py-5 rounded-sm shadow-2xl text-xl mt-6 tracking-widest transition-all">åŒæ„å”è­°ä¸¦å®Œæˆæ•¸ä½ç°½ç½²</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBEMq10DZ9M2JQVM1VkTSv463c4X_HfyL8tNT52_3UjIEagemn6DuF2wU0ZIEmVwUK8g/exec"; 
        const DATA_URL = "https://raw.githubusercontent.com/Artheryu/puffmoney-nda/main/data.json"; 
        let whitelist = {}, fullContractText = "", isDataLoaded = false, isWaiting = false;

        (async function preload() {
            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                const result = await res.json();
                whitelist = result.whitelist; fullContractText = result.contractText;
                isDataLoaded = true; if (isWaiting) proceedToStep2();
            } catch (e) { console.error("è³‡æ–™é è¼‰å¤±æ•—", e); }
        })();

        const isOverseas = document.getElementById('isOverseas');
        const inputID = document.getElementById('inputID');
        isOverseas.onchange = function() {
            inputID.value = ""; 
            if (this.checked) {
                inputID.placeholder = "è«‹è¼¸å…¥è­·ç…§æˆ–è­‰ä»¶è™Ÿç¢¼"; inputID.removeAttribute('maxlength'); inputID.classList.remove('uppercase');
            } else {
                inputID.placeholder = "A123456789"; inputID.setAttribute('maxlength', '10'); inputID.classList.add('uppercase');
            }
        };

        const canvas = document.getElementById('signatureCanvas');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });

        // ğŸ’¡ æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶é˜²æ­¢è§¸æ§æ»‘å‹•
        canvas.addEventListener("touchstart", function(e) { if (e.target === canvas) e.preventDefault(); }, { passive: false });
        canvas.addEventListener("touchmove", function(e) { if (e.target === canvas) e.preventDefault(); }, { passive: false });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio); signaturePad.clear();
        }

        function validateID(id) {
            if (isOverseas.checked) return id.length >= 3;
            if (!/^[A-Z][1-2]\d{8}$/.test(id)) return false;
            const map = {A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,J:18,K:19,L:20,M:21,N:22,P:23,Q:24,R:25,S:26,T:27,U:28,V:29,X:30,Y:31,W:32,Z:33,I:34,O:35};
            const n = map[id[0]], x1 = Math.floor(n/10), x2 = n%10, d = id.slice(1).split('').map(Number);
            let sum = x1 + x2*9; for(let i=0;i<8;i++) sum += d[i]*[8,7,6,5,4,3,2,1][i];
            return (sum + d[8]) % 10 === 0;
        }

        document.getElementById('infoForm').onsubmit = function(e) {
            e.preventDefault();
            const idValue = inputID.value.trim().toUpperCase();
            if (!validateID(idValue)) { 
                Swal.fire({ icon: 'error', title: 'æ ¼å¼éŒ¯èª¤', text: isOverseas.checked ? 'è«‹è¼¸å…¥æœ‰æ•ˆçš„è­‰ä»¶è™Ÿç¢¼' : 'è«‹è¼¸å…¥æ­£ç¢ºçš„å°ç£èº«åˆ†è­‰å­—è™Ÿ' }); 
                return; 
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
            if (isDataLoaded) proceedToStep2(); else isWaiting = true;
        };

        function proceedToStep2() {
            const date = document.getElementById('inputDate').value.trim();
            if (!whitelist[date]) {
                document.getElementById('loadingOverlay').style.display = 'none'; isWaiting = false;
                Swal.fire({ icon: 'error', title: 'æ—¥æœŸä¸æ­£ç¢º', text: 'è«‹è·Ÿå®¢æœç¢ºèªä¸Šèª²æ—¥æœŸ' }); return;
            }
            const bold = (val, id) => `<span id="${id}" class="highlight-bold">${val}</span>`;
            let pText = fullContractText;
            const now = new Date(); const rocY = now.getFullYear() - 1911;
            pText = pText.replace(/{{Name}}/g, bold(document.getElementById('inputName').value, 'namePrev'))
                         .replace(/{{ID}}/g, bold(inputID.value.toUpperCase(), 'idPrev'))
                         .replace(/{{Phone}}/g, bold(document.getElementById('inputPhone').value, 'phonePrev'))
                         .replace(/{{Email}}/g, bold(document.getElementById('inputEmail').value, 'emailPrev'))
                         .replace(/{{Address}}/g, bold("å°šæœªå¡«å¯«", 'addrLivePrev'))
                         .replace(/{{Year}}/g, bold(rocY, 'yPrev'))
                         .replace(/{{Month}}/g, bold(now.getMonth() + 1, 'mPrev'))
                         .replace(/{{Day}}/g, bold(now.getDate(), 'dPrev'))
                         .replace(/{{Signature}}/g, "\n\n");
            document.getElementById('displayName').innerText = document.getElementById('inputName').value;
            document.getElementById('contractDisplay').innerHTML = pText;
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'none';
            isWaiting = false; setTimeout(resizeCanvas, 100); window.scrollTo(0,0);
            const addrInput = document.getElementById('inputAddress');
            const addrDisplay = document.getElementById('addrLivePrev');
            addrInput.oninput = function() { addrDisplay.innerText = this.value || "å°šæœªå¡«å¯«"; };
        }

        document.getElementById('clearBtn').onclick = () => signaturePad.clear();
        document.getElementById('finalSubmitBtn').onclick = async function() {
            const address = document.getElementById('inputAddress').value.trim();
            if (address === "") { Swal.fire({ icon: 'warning', title: 'è«‹å¡«å¯«åœ°å€' }); return; }
            if (signaturePad.isEmpty()) { Swal.fire({ icon: 'warning', title: 'å°šæœªç°½å' }); return; }
            document.getElementById('loadingOverlay').style.display = 'flex';
            const payload = {
                courseDate: document.getElementById('inputDate').value,
                name: document.getElementById('inputName').value,
                id: inputID.value.toUpperCase(), phone: document.getElementById('inputPhone').value,
                email: document.getElementById('inputEmail').value, address: address,
                signature_base64: signaturePad.toDataURL()
            };
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                document.getElementById('loadingOverlay').style.display = 'none';
                if (result.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'ç°½ç½²å®Œæˆ', text: 'åˆç´„å‰¯æœ¬å·²å¯„é€è‡³ä¿¡ç®±ï¼Œæ„Ÿè¬æ‚¨çš„é…åˆï¼' }).then(() => location.reload());
                } else throw new Error(result.message);
            } catch (e) {
                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire({ icon: 'error', title: 'å‚³é€å¤±æ•—', text: e.toString() });
            }
        };
    </script>
</body>
</html>
